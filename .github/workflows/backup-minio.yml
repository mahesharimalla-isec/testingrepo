name: Backup Repo to MinIO

on:
  push:
    branches: ["testing"]
  schedule:
    - cron: "0 2 * * *"

jobs:
  backup:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create backup zip
        run: zip -r repo.zip .git

      - name: Encrypt backup
        run: |
          echo "${{ secrets.BACKUP_ENCRYPTION_KEY }}" > key.txt
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in repo.zip -out repo.enc \
            -pass file:key.txt
          rm key.txt repo.zip

      - name: Install MinIO client
        run: |
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc

      - name: Debug MinIO Host
        run: echo "MINIO_HOST='${{ secrets.MINIO_HOST }}'"

      - name: Configure MinIO
        run: |
          ./mc alias set backup \
            "${{ secrets.MINIO_HOST }}" \
            "${{ secrets.MINIO_ACCESS_KEY }}" \
            "${{ secrets.MINIO_SECRET_KEY }}"

      - name: Upload backup to MinIO
        run: |
          FILE="backup-$(date +%Y%m%d-%H%M%S).enc"

          ./mc mb backup/github-backup --ignore-existing
          ./mc cp repo.enc "backup/github-backup/$FILE"
          echo "Uploaded: $FILE"
