name: Backup Repo to MinIO

on:
  push:
    branches: ["testing"]
  schedule:
    - cron: "0 2 * * *"

jobs:
  backup:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create backup (zip)
        run: zip -r repo.zip .git

      - name: Encrypt backup
        run: |
          echo "${{ secrets.BACKUP_ENCRYPTION_KEY }}" > key.txt
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in repo.zip -out repo.enc \
            -pass file:key.txt
          rm -f key.txt repo.zip

      - name: Install MinIO client
        run: |
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc

      - name: Configure MinIO alias
        run: |
          ./mc alias set backup \
            "${{ secrets.MINIO_HOST }}" \
            "${{ secrets.MINIO_ACCESS_KEY }}" \
            "${{ secrets.MINIO_SECRET_KEY }}"

      - name: Upload backup to MinIO
        run: |
          REPO="${GITHUB_REPOSITORY##*/}"
          TIME=$(date +%Y%m%d-%H%M%S)
          FILE="${REPO}-${TIME}.enc"

          # Create bucket if not exist
          ./mc mb backup/github-backup --ignore-existing

          # Upload
          ./mc cp repo.enc backup/github-backup/"$FILE"

          echo "Uploaded: $FILE"
