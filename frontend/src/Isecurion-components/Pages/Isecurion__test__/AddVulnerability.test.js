import React from "react";
import { BrowserRouter } from "react-router-dom";
import AddVulnerability from '../AddVulnerability'
import { fireEvent, render, screen, getByRole } from "@testing-library/react";

jest.mock('../../../Context/UserAuthContext', () => ({
    useUserAuth: () => ({
        logout: jest.fn(),
    }),
}));

jest.mock('../../../Config/Firebaseconfig', () => ({
    database: {},
}));

window.scrollTo = jest.fn();

jest.mock('firebase/firestore', () => ({
    collection: jest.fn(),
    doc: jest.fn(),
    onSnapshot: jest.fn(() => jest.fn()),
    where: jest.fn(),
    query: jest.fn(),
    getDocs: jest.fn()
}));

jest.mock('firebase/auth', () => ({
    onAuthStateChanged: jest.fn(),
}));
const router = <BrowserRouter><AddVulnerability /></BrowserRouter>

describe("Add vulnerability", () => {

    test("render header", () => {
        render(router)

        const header = screen.getByText("Add Vulnerability")
        expect(header).toBeInTheDocument()
    })

    test("render vulnerability label", () => {

        render(router)

        const label1 = screen.getByText("Vulnerability:")
        expect(label1).toBeInTheDocument()
    })

    test("render severity label", () => {

        render(router)
        const label2 = screen.getByText("Severity:")
        expect(label2).toBeInTheDocument()
    })

    test("render Affected parameter label", () => {

        render(router)
        const label3 = screen.getByText("Affected parameter:")
        expect(label3).toBeInTheDocument()
    })

    test("render recommendations label", () => {

        render(router)
        const label4 = screen.getByText("Recommendations:")
        expect(label4).toBeInTheDocument()
    })

    test("render Proof of concepts label", () => {

        render(router)
        const label5 = screen.getByText("Proof of Concept:")
        expect(label5).toBeInTheDocument()
    })

    test('render onclick Add vulnerability event', async () => {
        render(router),
            fireEvent.click(screen.getByText('Upload vulnerability'));
    })

    test('render vulnerability name input', () => {
        render(router)
        const vulnerabilityinput = screen.getByPlaceholderText("Vulnerability name")
        expect(vulnerabilityinput).toBeInTheDocument()
    })

    test('should update severity when selecting an option', () => {
        const { getByTestId, getByText } = render(router);

        const labelElement = getByText('Severity:');
        const selectElement = getByText('Severity:').nextSibling;

        fireEvent.change(selectElement, { target: { value: 'High' } });

        expect(selectElement.value).toBe('High');
        expect(labelElement).toBeInTheDocument();

        const selectOption = getByTestId('Select');
        expect(selectOption).toBeInTheDocument();
    });

    test('render  affected item input', () => {
        render(router)
        const parameterinput = screen.getByPlaceholderText("Affected item")
        expect(parameterinput).toBeInTheDocument()
    })

    test('render  Recommendations item input', () => {
        render(router)
        const parameterinput = screen.getByPlaceholderText("Recommendations")
        expect(parameterinput).toBeInTheDocument()
    })

    test("should display the selected file name", async () => {
        const { getByTestId } = render(router)

        const fileInput = getByTestId('fileInput')
        const file = new File(['test file content'], 'test.jpg', { type: 'text/plain' })

        fireEvent.change(fileInput, { target: { files: [file] } })

        expect(fileInput.files).toHaveLength(1);
        expect(fileInput.files[0].name).toBe('test.jpg');
    })

      test("vulnerability name should not be empty", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        fireEvent.change(inputvulnerabilityNode, { target: { value: "" } });
        fireEvent.click(addbutton);

        const message = await screen.findByText(/Vulnerability name required!/i);
        expect(message).toBeInTheDocument();
      });

      test("severity should not be empty", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputseverityNode = screen.getByTestId("Select");
        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "" } });

        fireEvent.click(addbutton);

        const message = await screen.findByText("Severity not selected!");
        expect(message).toBeInTheDocument();
      });

      test("affected parameter should not be empty", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputparametreNode = screen.getByPlaceholderText("Affected item")
        const inputseverityNode = screen.getByTestId("Select");
        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "Critical" } });
        fireEvent.change(inputparametreNode, { target: { value: "" } });
        fireEvent.click(addbutton);

        const message = await screen.findByText("Affected parameter not specified!");
        expect(message).toBeInTheDocument();
      });

      test("recommendations should not be empty", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputparametreNode = screen.getByPlaceholderText("Affected item")
        const inputseverityNode = screen.getByTestId("Select");
        const inputrecommendationNode = screen.getByPlaceholderText("Recommendations")
        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "Critical" } });
        fireEvent.change(inputparametreNode, { target: { value: "naofebvfvbgbcv" } });
        fireEvent.change(inputrecommendationNode, { target: { value: "" } });
        fireEvent.click(addbutton);

        const message = await screen.findByText("Recommendations required!");
        expect(message).toBeInTheDocument();
      });

      test("select images", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputparametreNode = screen.getByPlaceholderText("Affected item")
        const inputseverityNode = screen.getByTestId("Select");
        const inputrecommendationNode = screen.getByPlaceholderText("Recommendations")
        const inputImageNode = screen.getByTestId("fileInput")
        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "Critical" } });
        fireEvent.change(inputparametreNode, { target: { value: "naofebvfvbgbcv" } });
        fireEvent.change(inputrecommendationNode, { target: { value: "erfgfvvef" } });
        fireEvent.change(inputImageNode, { target: { value: "" } });
        fireEvent.click(addbutton);

        const message = await screen.findByText("Proof of concept file required!");
        expect(message).toBeInTheDocument();
      });

      test("select only 10 images", async () => {
        render(router);

        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputparametreNode = screen.getByPlaceholderText("Affected item");
        const inputseverityNode = screen.getByTestId("Select");
        const inputrecommendationNode = screen.getByPlaceholderText("Recommendations");
        const inputImageNode = screen.getByTestId("fileInput");

        const files = Array.from({ length: 11 }, (_, index) => new File([''], `file${index}.png`, { type: 'image/png' }));

        const fileInput = {
          target: {
            files: files,
          },
        };

        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "Critical" } });
        fireEvent.change(inputparametreNode, { target: { value: "naofebvfvbgbcv" } });
        fireEvent.change(inputrecommendationNode, { target: { value: "erfgfvvef" } });
        fireEvent.change(inputImageNode, fileInput);
        fireEvent.click(addbutton);

        const message = await screen.findByText("You can upload a maximum of 10 photos");
        expect(message).toBeInTheDocument();
      });

      test("Error uploading vulnerability", async () => {
        render(router);
        const addbutton = screen.getByRole("button");
        const inputvulnerabilityNode = screen.getByPlaceholderText("Vulnerability name");
        const inputparametreNode = screen.getByPlaceholderText("Affected item");
        const inputseverityNode = screen.getByTestId("Select");
        const inputrecommendationNode = screen.getByPlaceholderText("Recommendations");
        const inputImageNode = screen.getByTestId("fileInput");

        const files = Array.from({ length: 10 }, (_, index) => new File([''], `file${index}.png`, { type: 'image/png' }));

        const fileInput = {
          target: {
            files: files,
          },
        };

        fireEvent.change(inputvulnerabilityNode, { target: { value: "Manjesh" } });
        fireEvent.change(inputseverityNode, { target: { value: "Critical" } });
        fireEvent.change(inputparametreNode, { target: { value: "naofebvfvbgbcv" } });
        fireEvent.change(inputrecommendationNode, { target: { value: "erfgfvvef" } });
        fireEvent.change(inputImageNode, fileInput);
        fireEvent.click(addbutton);

        const message = await screen.findByText("Error uploading vulnerability", { timeout: 5000 });
        expect(message).toBeInTheDocument();
      });

})
