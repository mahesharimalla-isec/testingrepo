import { faPenToSquare, faPlus } from '@fortawesome/free-solid-svg-icons';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import React, { useEffect, useState } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import './pages-css/Vulnerability.css';
import { useSelector, useDispatch } from 'react-redux';
import { updateProjectStatus } from '../../REDUX_ISECURION/retestStatus/retestAction';
import { setVulnerabilities } from '../../REDUX_ISECURION/vulnerList/vulnerActions';
import { faCircleCheck, faCircleXmark } from '@fortawesome/free-regular-svg-icons';
import CustomRetest from './CustomRetest';
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
import { useAuth } from '../../Context/UserContext';
import { io } from 'socket.io-client';

const VulnerabilityTable = ({ project }) => {
  const navigate = useNavigate();
  const { projectid } = useParams();
  const socket = io('http://18.207.195.77:5050');

  const [editStates, setEditStates] = useState([]);
  const [selectedOption, setSelectedOption] = useState('');
  const [iconVisible, setIconVisible] = useState(true);

  const vulnerabilities = useSelector((state) => state.vulnerlist.vulnerabilities);
  const projectStatus = useSelector((state) => state.project.projectStatus);

  const dispatch = useDispatch();

  const addProjectSuccess = () => {
    toast.success("Retest status updated...", {
      position: "top-right",
      autoClose: 2500,
      pauseOnHover: false,
    });
  };


  const handleOptionChange = (e) => {
    setSelectedOption(e.target.value);
  };

  const fetchprojectStatus = async () => {
    try {
      const response = await fetch(`http://18.207.195.77:5050/fetchprojectstatus?projectId=${projectid}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: 'include'
      });
      const status = await response.json();
      dispatch(updateProjectStatus(status));
    } catch (error) {
      console.log(error);
    }
  };

  const fetchVulnerability = async () => {
    try {
      const response = await fetch(`http://18.207.195.77:5050/fetchvulnerability?projectId=${projectid}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
        credentials:'include'
      });

      if (response.status === 404) {
        dispatch(setVulnerabilities([]));
        return;
      }

      const vulnerabilityDetails = await response.json();
      dispatch(setVulnerabilities(vulnerabilityDetails));
    } catch (error) {
      console.log(error);
    }
  };

  useEffect(() => {
    fetchVulnerability();
    fetchprojectStatus();

    socket.on('fetchclientcommentandvulnerability', async()=>{
      await fetchVulnerability()
    })

    socket.on("enable_retest_status_column", async()=>{
      await fetchprojectStatus()
    })

    return () => {
      socket.disconnect();
    };
  }, []);

  const handleEditClick = (index, documentId) => {
    const newEditStates = [...editStates];
    newEditStates[index] = true;
    setEditStates(newEditStates);
    setIconVisible(false);
  };

  const handleCancelEdit = (index, documentId) => {
    const newEditStates = [...editStates];
    newEditStates[index] = false;
    setEditStates(newEditStates);
    setIconVisible(true);
  };

  const handleSaveClick = async (index, documentId) => {
    try {
      const response = await fetch('http://18.207.195.77:5050/updatereteststatus', {
        method: "PUT",
        headers: {
          'Content-Type': 'application/json',
        },
        credentials:'include',
        body: JSON.stringify({
          vulnerabilityId: documentId,
          selectedOption
        })
      });

      if (response.ok) {
        const result = await response.json();
        setSelectedOption('')
        setVulnerabilities(result.vulnerability);
        addProjectSuccess();
        fetchVulnerability();
      } else {
        const errorResult = await response.json();
        console.error(errorResult.message);
        toast.error(errorResult.message, {
          position: "top-right",
          autoClose: 2500,
          pauseOnHover: false,
        });
      }
      const newEditStates = [...editStates];
      newEditStates[index] = false;
      setEditStates(newEditStates);
      setIconVisible(true);
    } catch (error) {
      console.log(error);
    }
  };

  const getVulStatus = (severity) => {
    switch (severity) {
      case 'Critical': return 'critical';
      case 'High': return 'high';
      case 'Medium': return 'medium';
      case 'Low': return 'low';
      case 'Info': return 'info';
      default: return '';
    }
  };

  const getSeverityValue = (severity) => {
    switch (severity) {
      case 'Critical': return 1;
      case 'High': return 2;
      case 'Medium': return 3;
      case 'Low': return 4;
      case 'Info': return 5;
      default: return 6;
    }
  };
  const sortedVulnerabilities = [...vulnerabilities].sort((a, b) => getSeverityValue(a.severity) - getSeverityValue(b.severity));


  const escapeHtml = (html) => {
    return html.replace(/[&<>]/g, function (tag) {
      const charsToReplace = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
      };
      return charsToReplace[tag] || tag;
    });
  };


  return (
    <div className='wrapvulnerable'>
      <div className='wrap-isec-vulnerabilities'>
        <div className='list-vuln'>
          <div className='heading'>
            <h3>List of Vulnerabilities</h3>
          </div>
          <div className='heading_button'>
            <button onClick={() => navigate(`/isecurion_dash/status/${projectid}/addvuln`)}>
              <FontAwesomeIcon icon={faPlus} /> Add
            </button>
          </div>
        </div>
        <div className='wrapvul-table'>
          <table className='table-vulner'>
            <thead>
              <tr>
                <th>No.</th>
                <th>Vulnerability</th>
                <th>Severity</th>
                <th>Affected Item</th>
                <th>Recommendations</th>
                <th>Client Comments</th>
                {(projectStatus === 'Retesting' || projectStatus === 'Completed') && <th>Retest Status</th>}
              </tr>
            </thead>
            <tbody>
              {sortedVulnerabilities.length === 0 ? (
                <tr className='collapse'>
                  <td colSpan={projectStatus === 'Retesting' || projectStatus === 'Completed' ? '7' : '6'} style={{ color: "red", fontWeight: "500" }}>
                    Vulnerability records not found....
                  </td>
                </tr>
              ) : (
                sortedVulnerabilities.map((vulnerability, index) => (
                  <tr key={index}>
                    <td>{index + 1}</td>

                    <td>{vulnerability.vulnerabilityName}</td>
                    <td className={getVulStatus(vulnerability.severity)}>{vulnerability.severity}</td>
                    <td style={{ wordBreak: 'break-word' }}>{vulnerability.affectedParameter}</td>
                    <td className='recommendations' dangerouslySetInnerHTML={{ __html: escapeHtml(vulnerability.recommendation).replace(/\n/g, '<br>') }}></td>
                    <td style={{ wordBreak: 'break-word' }}>{vulnerability.comments}</td>
                    {(projectStatus === 'Retesting' || projectStatus === 'Completed') &&
                      <td className='status_retest'>
                        <button className='button_retest'>
                          {editStates[index] ? (
                            <CustomRetest style={{ border: "1px solid #cdc0c0" }}
                              placeholder="Select"
                              options={['Fixed', 'Not Fixed', 'NA']}
                              value={selectedOption}
                              onChange={(option) => setSelectedOption(option)}
                            />
                          ) : (
                            <p>{vulnerability.retestStatus}</p>
                          )}
                        </button>
                        {editStates[index] ? (
                          <div>
                            <button className='cancel_save' onClick={() => handleCancelEdit(index)}>
                              <FontAwesomeIcon icon={faCircleXmark} />
                            </button>
                            <button className='edit_saveclick' onClick={() => handleSaveClick(index, vulnerability._id)}>
                              <FontAwesomeIcon icon={faCircleCheck} />
                            </button>
                          </div>
                        ) : (
                          <button className="icons" onClick={() => handleEditClick(index)}>
                            <FontAwesomeIcon icon={faPenToSquare} />
                          </button>
                        )}
                      </td>}
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  );
};

export default VulnerabilityTable;
