import React, { useEffect, useState } from 'react';
import IsecNavbar from './IsecNavbar';
import './pages-css/AddVulnerability.css';
import { Link, useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../../Context/UserContext.js'
import { faCircleCheck, faCircleXmark } from '@fortawesome/free-regular-svg-icons';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faCaretRight } from '@fortawesome/free-solid-svg-icons';
import { ToastContainer, toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';


const AddVulnerability = () => {
  const { projectid } = useParams();

  const navigate = useNavigate()

  let previousLength = 0;

  const {logout, emailVer}= useAuth()

  const [vulnerability, setVulnerability] = useState('');
  const [severity, setSeverity] = useState('');
  const [parameter, setParameter] = useState('');
  const [recommend, setrecommend] = useState('');
  const [files, setFiles] = useState([]);
  const [buttonVisible, setButtonVisible] = useState(true)
  const [waitingPage, setWaitingPage] = useState(false)

  const [vulnerabilityError, setVulnerabilityError] = useState('')
  const [severityError, setSeverityError] = useState('')
  const [parameterError, setParameterError] = useState('')
  const [recommendationsError, setrecommendationsError] = useState('')
  const [fileError, setFileError] = useState('')

  const [projectName, setProjectName] = useState('')

  const addVulnerabilitySuccess = () => {
    toast.success("Vulnerability added successfully...", {
      position: "top-right",
      autoClose: 2500,
      pauseOnHover: false,
    });
  };

  const addVulnerabilityError = () => {
    toast.error("Error uploading vulnerability", {
      position: "top-right",
      autoClose: 2500,
      pauseOnHover: false,
    });
  };


  const fetchProjectName = async () => {
    try {
      const response = await fetch(`http://18.207.195.77:5050/fetchprojectname?projectId=${projectid}`, {
        method: 'GET',
        headers: {
          "Content-Type": "application/json",
        },
        credentials:'include'
      })
      const result = await response.json();
      setProjectName(result)

    } catch (error) {
      console.log(error);
    }
  }

  useEffect(() => {
    if (!emailVer.endsWith('@isecurion.com')) {
      logout()
      return;
    }
    fetchProjectName()
    window.scrollTo(0, 0);
  }, [])

  // const handleInput = (event) => {
  //   const bullet = "\u2022";
  //   const newLength = event.target.value.length;
  //   const characterCode = event.target.value.substr(-1).charCodeAt(0);
  //   if (newLength > previousLength) {
  //     if (characterCode === 10) {
  //       event.target.value = `${event.target.value}${bullet} `;
  //     } else if (newLength === 1) {
  //       event.target.value = ` ${event.target.value}`;
  //     }
  //   }
  //   previousLength = newLength;
  // }

  const capitalizeFirstLetter = (string) => {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  const capitalizedClientName = capitalizeFirstLetter(vulnerability);

  const allowedFileTypes = ['image/jpg', 'image/png', 'image/jpeg'];

const handleUpload = async () => {
  if (capitalizedClientName === '') {
    return setVulnerabilityError('Vulnerability name required!');
  }
  if (severity === '' || severity === 'Select') {
    return setSeverityError('Severity not selected!');
  }
  if (parameter === '') {
    return setParameterError('Affected parameter not specified!');
  }
  if (recommend === '') {
    return setrecommendationsError('Recommendations required!');
  }
  if (!files || files.length === 0) {
    return setFileError('Proof of concept file required!');
  }
  if (files.length > 10) {
    return setFileError('You can upload a maximum of 10 photos');
  }

  for (const file of files) {
    if (!allowedFileTypes.includes(file.type)) {
      return setFileError(`Invalid file type. Only JPG, PNG, and JPEG are allowed!`);
    }
  }

  const formData = new FormData();
  for (const file of files) {
    formData.append('files', file);
  }
  formData.append('projectId', projectid);
  formData.append('vulnerabilityName', capitalizeFirstLetter(vulnerability));
  formData.append('severity', severity);
  formData.append('affectedParameter', parameter);
  formData.append('recommendation', recommend);


  try {
    const response = await fetch("http://18.207.195.77:5050/uploadvulnerability", {
      method: "POST",
      credentials: 'include',
      body: formData
    });
    console.log(response);
    if (response.ok) {
      addVulnerabilitySuccess();
      setVulnerability('');
      setSeverity('Select');
      setParameter('');
      setrecommend('');
      setFiles(null);
      document.getElementById('fileInput').value = '';
    } else {
      addVulnerabilityError();
    }
  } catch (error) {
    toast.error(`${error.response ? error.response.data.message : error.message}`, {
      position: "top-right",
      autoClose: 2500,
      pauseOnHover: false,
    });
    addVulnerabilityError();
  }
};


  return (
    <div className='addvulnerability' >
      <div className='addvuln-navbar'>
        <IsecNavbar />
      </div>
      <div className='vulnerability_wrap_pagedata'>
        <div className='add_vulnerability_router'>
          <Link to='/isecurion_dash'>Dashboard</Link>
          <p><FontAwesomeIcon icon={faCaretRight} /></p>
          <h3 onClick={() => navigate(-1)}>{projectName}</h3>

          <p><FontAwesomeIcon icon={faCaretRight} /></p>
          <h4>Add vulnerability</h4>
        </div>
        <div className='wrap_pagedata'>
          <div className='left_space'></div>

          <div className='wrap_add_vulnerability'>

            <h1 className='addvulnerabilityh1'>Add Vulnerability</h1>

            <div className='wrap_first_second'>

              <div className='first_vulnerability'>
                <label>Vulnerability:</label>
                <textarea
                  placeholder='Vulnerability name'
                  value={vulnerability}
                  onChange={(e) => {
                    setVulnerability(capitalizeFirstLetter(e.target.value))
                    setVulnerabilityError('')
                  }} />
                {vulnerabilityError && <p className='vulnererrorh5'>{vulnerabilityError}</p>}
              </div>
              <div className='second-severity'>
                <label>Severity:</label>
                <select data-testid="Select" value={severity} onChange={(e) => {
                  setSeverity(e.target.value)
                  setSeverityError('')
                }}>
                  <option>Select</option>
                  <option>Critical</option>
                  <option>High</option>
                  <option>Medium</option>
                  <option>Low</option>
                  <option>Info</option>
                </select>
                {severityError && <p className='severity_errorh5'>{severityError}</p>}
              </div>

            </div>

            <div className='third-parameter'>
              <label>Affected parameter: </label>
              <textarea
                placeholder='Affected item'
                value={parameter}
                onChange={(e) => {
                  setParameter(e.target.value)
                  setParameterError('')
                }} />
              {parameterError && <p>{parameterError}</p>}
            </div>

            <div className='fourth-recommend'>
              <label>Recommendations:</label>
              <textarea
                placeholder='Recommendations'
                value={recommend}
                // onInput={handleInput}
                rows="10"
                onChange={(e) => {
                  setrecommend(e.target.value)
                  setrecommendationsError('')
                }} />
              {recommendationsError && <p>{recommendationsError}</p>}
            </div>

            <div className='last_image'>
              <label>Proof of Concept:</label>
              <input
                type='file'
                id='fileInput'
                data-testid='fileInput'
                onChange={(e) => {
                  setFiles(e.target.files)
                  setFileError('')
                }}
                multiple
              ></input>
              {fileError && <p>{fileError}</p>}
            </div>


            <button data-testid='Upload vulnerability' onClick={handleUpload}>Upload vulnerability</button>

          </div>

          <div className='right_space'></div>
        </div>

      </div>

      {waitingPage && (
        <div className='waiting_page'>
          <div className='wrap_Waiting'>
            <p>Please wait...</p>
            <div id='loaderPage' className='loading-spinnerPage'></div>
          </div>
        </div>
      )}

      {/* <ToastContainer /> */}

    </div>

  );
};

export default AddVulnerability;
